@model BOCS.ModelsView.LessonManageVM
@{
    ViewData["Title"] = "Manage Lessons";
}

<section class="container py-4">
    <h4 class="mb-3">@Model.CourseTitle — Lessons</h4>

    @if (TempData["StatusMessage"] is string m)
    {
        <div class="alert alert-success py-2">@m</div>
    }

    <div class="d-flex gap-2 mb-3">
        <a class="btn btn-sm btn-success"
           asp-controller="CourseLesson"
           asp-action="Create"
           asp-route-courseId="@Model.CourseId">
            + Add Lesson
        </a>

        <a class="btn btn-sm btn-outline-secondary"
           asp-controller="CourseLesson"
           asp-action="Index">
            ← Back to courses
        </a>

        <button id="saveOrderBtn" class="btn btn-sm btn-primary ms-auto d-none">
            Save order
        </button>
    </div>

    <div class="alert alert-info py-2" id="dragHint">
        Tip: Drag the handle (≡) up or down to change the order. Changes will be <b>Saved</b> automatically
    </div>

    <form id="reorderForm">
        @Html.AntiForgeryToken()
        <input type="hidden" id="courseId" value="@Model.CourseId" />
    </form>

    <table class="table table-sm align-middle" id="lessonTable">
        <thead>
            <tr>
                <th style="width:50px">#</th>
                <th style="width:60px">Order</th>
                <!-- ✅ নতুন: master checkbox -->
                <th style="width:60px" class="text-center">
                    <label class="form-check-label small">Tic</label>
                    <input id="chkAll" type="checkbox" class="form-check-input" />
                </th>
                <th>Title</th>
                <th>Images</th>
                <th>Files</th>
                <th style="width:180px">YouTube Id</th>
                <th style="width:120px">Published</th>
                <th style="width:140px" class="text-end">Actions</th>
            </tr>
        </thead>
        <tbody id="lessonTbody">
            @foreach (var l in Model.Lessons.OrderBy(x => x.SortOrder).ThenBy(x => x.Id))
            {
                <tr class="dr-row" data-id="@l.Id">
                    <td class="drag-cell">
                        <span class="drag-handle" title="Drag to reorder" role="button">≡</span>
                    </td>
                    <td class="order-cell">@l.SortOrder</td>
                    <!-- ✅ প্রতিটি row-র single checkbox -->
                    <td class="text-center">
                        <input type="checkbox" class="chk-one" @(l.IsPlay ? "checked" : "") />
                    </td>
                    <td>@l.Title</td>
                    <td>
                        @if (l.ImageCount == 0)
                        {
                            <span class="text-muted">No images</span>
                        }
                        else
                        {
                            <span class="badge bg-info">@l.ImageCount image@(l.ImageCount == 1 ? "" : "s")</span>
                        }
                    </td>
                    <td>
                        @if (l.FileCount == 0)
                        {
                            <span class="text-muted">No files</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@l.FileCount file@(l.FileCount == 1 ? "" : "s")</span>
                        }
                    </td>
                    <td><code class="text-danger">@l.YoutubeId</code></td>
                    <td>@(l.IsPublished ? "Yes" : "No")</td>
                    <td class="text-end">


                        <a class="btn btn-sm btn-outline-primary"
                           asp-controller="CourseLesson"
                           asp-action="Edit"
                           asp-route-courseId="@Model.CourseId"
                           asp-route-id="@l.Id">Edit</a>
                        <a class="btn btn-sm btn-outline-danger"
                           asp-controller="CourseLesson"
                           asp-action="Delete"
                           asp-route-courseId="@Model.CourseId"
                           asp-route-id="@l.Id">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div id="saveToast" class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3 d-none" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">✅ Order saved.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="hideToast()"></button>
        </div>
    </div>
</section>

@section Styles {
    <link rel="stylesheet" href="~/css/course-lesson-manage.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/course-lesson-manage.js" asp-append-version="true"></script>
}