@using System.Text.Json
@model BOCS.ModelsView.CourseInfoVM
@{
    ViewData["Title"] = "Course Info";
    var playMap = ViewBag.LessonPlay as IDictionary<string, bool> ?? new Dictionary<string, bool>();
    var isEnrolled = (bool)ViewBag.isEnrolled;
    bool isAdmin = User.IsInRole("Admin");
    var idx = 0;

    // initialId: Controller থেকে এলো (শুধু play-able হলে সেট করা)
    var initialId = Model.LatestYoutubeId
        ?? Model.Outlines.SelectMany(g => g.Items).FirstOrDefault()?.YoutubeId
        ?? "";

}

<section class="container py-4 lock-copy">
    <div class="mb-2 text-muted">Courses Lesson List</div>
    <div class="row g-3">
        <div class="col-lg-4">
            <h5 class="mt-3"><u>Course Outlines:</u></h5>
            <div class="accordion" id="outlineAcc">
                @for (var gi = 0; gi < Model.Outlines.Count; gi++)
                {
                    var g = Model.Outlines[gi];
                    var cid = $"collapse_{gi}";
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading_@gi">
                            <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#@cid"
                            aria-expanded="false" aria-controls="@cid">
                                @g.Title
                            </button>
                        </h2>
                        <div id="@cid" class="accordion-collapse collapse" data-bs-parent="#outlineAcc">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush">
                                    @foreach (var item in g.Items)
                                    {
                                        var yt = item.YoutubeId ?? "";
                                        var canPlay = playMap.TryGetValue(yt, out var v) && v;
                                        if (!isEnrolled)
                                        {
                                            canPlay = false;
                                        }
                                        var isActive = yt == initialId;

                                        <li class="list-group-item d-flex justify-content-between align-items-center lesson-item @(isActive ? "active" : "") @(canPlay? "" : "disabled-lesson")"
                                            data-idx="@idx" data-yt="@yt" data-canplay="@(canPlay.ToString().ToLower())"
                                            role="button" tabindex="0">
                                            <span class="text-truncate">@item.Label</span>
                                            <i class="bi bi-play-circle"></i>
                                        </li>
                                        idx++;
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="col-lg-8 ms-lg-auto text-end">
        
        <div>

            <div class="d-flex justify-content-between align-items-start mb-3">
                
                <h4 class="mb-2">@Model.Title</h4>
            </div>
                <div id="videoShell" class="video-shell ratio ratio-16x9 mb-3">
                    <div id="videoTop" class="video-frame"></div>
                    <div class="video-mask tl" aria-hidden="true"></div>
                    <div class="video-mask tr" aria-hidden="true"></div>
                    <div class="guard guard-copy" aria-hidden="true"></div>
                    <div class="guard guard-more" aria-hidden="true"></div>
                    <div class="guard guard-yt" aria-hidden="true"></div>
                    <div class="guard guard-gear" aria-hidden="true"></div>
                    <div class="guard guard-cc" aria-hidden="true"></div>
                </div>
        </div>
           

            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h4 class="mb-2">@Model.Title</h4>
                    <div class="text-muted">Created by: @Model.CreatedBy</div>
                </div>
                <div class="text-end">
                    <div class="mb-2"><span class="fw-semibold me-1">Duration:</span> @Model.DurationDays days</div>
                    <div><span class="fw-semibold me-1">Price:</span> ৳ @Model.PriceBdt.ToString("N0") BDT</div>
                </div>
            </div>

            
        </div>
        <div class="col-lg-12">
            @if (isEnrolled)
            {
                @if (Model.CourseImages.Any() || Model.CourseDocuments.Any())
                {
                    <div class="mt-4">
                        <h5 class="mb-3">Course Materials</h5>

                        <!-- Images Section -->
                        @if (Model.CourseImages.Any())
                        {
                            <div class="mb-4">
                                <h6 class="text-muted mb-3">Images (@Model.CourseImages.Count)</h6>
                                <div class="row g-2">
                                     @foreach (var image in Model.CourseImages)
                                     {
                                         <div class="col-md-2 col-sm-3 col-4">
                                             <div class="card h-100 image-card" style="cursor: pointer;" data-image-src="@image.FilePath" data-image-name="@image.FileName">
                                                 <div class="card-img-container" style="height: 80px; overflow: hidden;">
                                                     <img src="@image.FilePath" class="card-img-top w-100 h-100" style="object-fit: cover;" alt="@image.FileName">
                                                 </div>
                                                 <div class="card-body p-2 d-flex flex-column" style="min-height: 60px;">
                                                     <div class="flex-grow-1">
                                                         <small class="text-muted d-block" style="font-size: 0.7rem; line-height: 1.1; word-break: break-word;">@image.FileName</small>
                                                         <small class="text-muted" style="font-size: 0.6rem;">@image.FileSize</small>
                                                     </div>
                                                     <div class="mt-1">
                                                         <button type="button" class="btn btn-sm btn-outline-success download-image-btn w-100" style="padding: 0.1rem 0.3rem; font-size: 0.7rem;" data-image-src="@image.FilePath" data-image-name="@image.FileName">
                                                             <i class="bi bi-download"></i> Download
                                                         </button>
                                                     </div>
                                                 </div>
                                             </div>
                                         </div>
                                     }
                                </div>
                            </div>
                        }

                        <!-- Documents Section -->
                        @if (Model.CourseDocuments.Any())
                        {
                            <div class="mb-4">
                                <h6 class="text-muted mb-3">Documents (@Model.CourseDocuments.Count)</h6>
                                <div class="list-group">
                                    @foreach (var doc in Model.CourseDocuments)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center document-item" data-doc-src="@doc.FilePath" data-doc-name="@doc.FileName">
                                            <div>
                                                <strong>@doc.FileName</strong>
                                                <br>
                                                <small class="text-muted">@doc.FileSize</small>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-primary view-document-btn" data-doc-src="@doc.FilePath">
                                                    <i class="bi bi-eye"></i> View
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            <!-- Course Attachments Section -->
            
        </div>
    </div>
</section>

<!-- Image Viewer Modal -->
<div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white" id="imageViewerModalLabel">Image Viewer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 position-relative">
                <div class="image-container position-relative" style="min-height: 70vh;">
                    <img id="modalImage" class="img-fluid w-100 h-100" style="object-fit: contain;" alt="Course Image">
                    
                    <!-- Navigation Arrows -->
                    <button type="button" class="btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-3" id="prevImageBtn" style="z-index: 10;">
                        &lsaquo;
                    </button>
                    <button type="button" class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-3" id="nextImageBtn" style="z-index: 10;">
                        &rsaquo;
                    </button>
                    
                   
                </div>
            </div>
            <div class="modal-footer border-0">
                <div class="text-white">
                    <span id="imageCounter">1 / 1</span>
                    <span class="ms-3" id="imageName">Image Name</span>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="IS_ADMIN_FLAG" value="@(isAdmin ? "true" : "false")" />

<style>
    .disabled-lesson {
        opacity: .55;
        cursor: not-allowed;
    }
</style>

@section Scripts {
    <script src="~/js/protect-course-info.js" asp-append-version="true"></script>

    <!-- প্লেয়ার যে আইডি দিয়ে শুরু করবে -->
    <script id="INITIAL_ID" type="application/json">
        @Html.Raw(JsonSerializer.Serialize(initialId))
    </script>

    <!-- (প্রয়োজন হলে) লেসন আইডিগুলোর তালিকা -->
    <script id="LESSON_IDS_DATA" type="application/json">
        @Html.Raw(JsonSerializer.Serialize(Model.LessonIds ?? new List<string>()))
    </script>

    <!-- প্লেয়ার/নেভিগেশন স্ক্রিপ্টগুলো -->
    <script src="~/js/course-info.bootstrap.js" asp-append-version="true"></script>
    <script src="~/js/course-info.js" asp-append-version="true"></script>

    <!-- ক্লিক-গার্ড (CSP safe: external file) -->
    <script src="~/js/course-play-guard.js" asp-append-version="true"></script>
    
    <!-- Attachments Viewer -->
    <script src="~/js/course-attachments-viewer.js" asp-append-version="true"></script>
}




@* @using System.Text.Json
@model BOCS.ModelsView.CourseInfoVM
@{
    ViewData["Title"] = "Course Info";

    var initialId = !string.IsNullOrWhiteSpace(Model.LatestYoutubeId)
        ? Model.LatestYoutubeId
        : (Model.Outlines.SelectMany(g => g.Items).FirstOrDefault()?.YoutubeId ?? "");
    var flatIds = Model.LessonIds ?? new List<string>();
    var idx = 0;
}

<section class="container py-4 lock-copy">
    <div class="mb-2 text-muted">Courses Lesson List</div>
    <div class="row g-3">
        <div class="col-lg-4">
            <h5 class="mt-3"><u>Course Outlines:</u></h5>

            <div class="accordion" id="outlineAcc">
                @for (var gIndex = 0; gIndex < Model.Outlines.Count; gIndex++)
                {
                    var g = Model.Outlines[gIndex];
                    var cid = $"collapse_{gIndex}";
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading_@gIndex">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#@cid"
                                    aria-expanded="false" aria-controls="@cid">
                                @g.Title
                            </button>
                        </h2>
                        <div id="@cid" class="accordion-collapse collapse" aria-labelledby="heading_@gIndex"
                             data-bs-parent="#outlineAcc">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush">
                                    @foreach (var item in g.Items)
                                    {
                                        var isActive = item.YoutubeId == initialId;
                                        <li class="list-group-item d-flex justify-content-between align-items-center lesson-item @(isActive ? "active" : "")"
                                            data-idx="@idx" data-yt="@item.YoutubeId" role="button" tabindex="0">
                                            <span class="text-truncate">@item.Label</span>
                                            <i class="bi bi-play-circle"></i>
                                        </li>
                                        idx++;
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="col-lg-8 ms-lg-auto text-end">
            <!-- Info.cshtml -->
            <div id="videoShell" class="video-shell ratio ratio-16x9 mb-3">
                <div id="videoTop" class="video-frame"></div>
                <div class="video-mask tl" aria-hidden="true"></div>
                <div class="video-mask tr" aria-hidden="true"></div>
                <div class="guard guard-copy" aria-hidden="true"></div> <!-- Top-right: Copy link -->
                <div class="guard guard-more" aria-hidden="true"></div> <!-- Center-bottom: “More videos” ওভারলে -->
                <div class="guard guard-yt" aria-hidden="true"></div> <!-- Bottom-right: YouTube/Watch -->
                <div class="guard guard-gear" aria-hidden="true"></div> <!-- Bottom-right: Settings -->
                <div class="guard guard-cc" aria-hidden="true"></div> <!-- Bottom-right: CC -->
            </div>

            <div class="d-flex justify-content-between align-items-start mb-3">
                <!-- Left Side -->
                <div>
                    <h4 class="mb-2">@Model.Title</h4>
                    <div class="text-muted">Created by: @Model.CreatedBy</div>
                </div>

                <!-- Right Side -->
                <div class="text-end">
                    <div class="mb-2">
                        <span class="fw-semibold me-1">Duration:</span>
                        @Model.DurationDays days
                    </div>
                    <div>
                        <span class="fw-semibold me-1">Price:</span>
                        ৳ @Model.PriceBdt.ToString("N0") BDT
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/protect-course-info.js" asp-append-version="true"></script>
    <script id="LESSON_IDS_DATA" type="application/json">
        @Html.Raw(System.Text.Json.JsonSerializer.Serialize(flatIds))
    </script>
    <script src="~/js/course-info.bootstrap.js" asp-append-version="true"></script>
    <!-- মূল লজিক: ক্লিক করলে প্লেয়ার বদলানো ইত্যাদি -->
    <script src="~/js/course-info.js" asp-append-version="true"></script>
    <script id="INITIAL_ID" type="application/json">
        @Html.Raw(JsonSerializer.Serialize(initialId ?? ""))
    </script>
} *@